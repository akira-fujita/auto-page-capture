# Kindle Page Capture - 設計ドキュメント

## 概要

KindleアプリのページをMac上で自動キャプチャし、PDFとして出力するGUIアプリケーション。章ごとに分割したPDF出力にも対応し、NotebookLMなどでの要約に活用しやすい形式で出力する。

## 技術スタック

- Python 3.x
- PyQt6（GUI）
- pyautogui（スクリーンショット・キー操作）
- Pillow（画像処理）
- img2pdf（PDF生成）
- Quartz / AppKit（macOSウィンドウ操作）

## ワークフロー

```
1. メイン画面で設定 → キャプチャ開始
         ↓
2. 自動キャプチャ実行（進捗表示）
         ↓
3. 完了後 → 章分割画面へ
         ↓
4. 章を定義してPDF出力
```

## UI設計

### メイン画面

```
┌─────────────────────────────────────────┐
│  Kindle Page Capture                    │
├─────────────────────────────────────────┤
│  対象ウィンドウ: [ドロップダウン ▼] [更新]│
│                                         │
│  ページ数:      [____] ページ           │
│  ページ送り方向: ○ → 右  ○ ← 左        │
│  キャプチャ間隔: [====○====] 1.0秒      │
│                                         │
│  ☑ 元の画像ファイルも保存する           │
│  保存先: [~/Desktop/captures] [参照...] │
│                                         │
│  [ キャプチャ開始 ]     [ キャンセル ]  │
│                                         │
│  進捗: ████████░░░░░░░░ 15/50 ページ    │
└─────────────────────────────────────────┘
```

### 章分割画面

```
┌────────────────────────────────────────────────────────┐
│  章の分割                                    [×]       │
├────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────┐   │
│  │ [1] [2] [3] [4] [5] [6] [7] [8] [9] [10] ...   │   │
│  │  📄  📄  📄  📄  📄  📄  📄  📄  📄  📄        │   │
│  │      ▲           ▲                             │   │
│  │     Ch1         Ch2                            │   │
│  └─────────────────────────────────────────────────┘   │
│                                                        │
│  章リスト:                                             │
│  ┌──────────────────────────────────────────────────┐  │
│  │ 📖 第1章 [名前を編集]  ページ 2-5    [×削除]    │  │
│  │ 📖 第2章 [名前を編集]  ページ 6-15   [×削除]    │  │
│  │ 📖 第3章 ...                                    │  │
│  └──────────────────────────────────────────────────┘  │
│                                                        │
│  [ + 章を追加 ]                                        │
│                                                        │
│  ☑ 全体を1つのPDFにもまとめる                         │
│                                                        │
│  [ PDF出力 ]                                           │
└────────────────────────────────────────────────────────┘
```

## モジュール構成

```
auto-page-capture/
├── main.py                 # エントリーポイント
├── requirements.txt        # 依存パッケージ
├── src/
│   ├── __init__.py
│   ├── ui/
│   │   ├── main_window.py      # メイン画面
│   │   └── chapter_dialog.py   # 章分割画面
│   ├── capture/
│   │   ├── window_manager.py   # ウィンドウ一覧取得・選択
│   │   ├── screenshot.py       # スクリーンショット撮影
│   │   └── page_navigator.py   # キー送信でページ送り
│   └── export/
│       ├── pdf_generator.py    # 画像→PDF変換
│       └── file_manager.py     # ファイル保存・削除管理
└── resources/
    └── icon.png            # アプリアイコン
```

### 主要クラスの責務

| クラス | 責務 |
|--------|------|
| `MainWindow` | UI表示、ユーザー入力の受付、キャプチャ実行の制御 |
| `ChapterDialog` | サムネイル表示、章区切りの編集、PDF出力指示 |
| `WindowManager` | macOSのウィンドウ一覧取得、コンテンツ領域の座標計算 |
| `Screenshot` | 指定領域のスクリーンショット撮影、一時保存 |
| `PageNavigator` | 対象アプリへのキー送信（←/→矢印） |
| `PdfGenerator` | 画像リストからPDF生成（全体/章別） |

## コア処理

### キャプチャシーケンス

```
MainWindow                    PageNavigator    Screenshot
    │                              │               │
    │  キャプチャ開始              │               │
    │─────────────────────────────────────────────>│
    │                              │               │ 1. スクリーンショット撮影
    │                              │               │ 2. 画像保存
    │<─────────────────────────────────────────────│
    │                              │               │
    │  ページ送り                  │               │
    │─────────────────────────────>│               │
    │                              │ キー送信(→/←) │
    │                              │───────>Kindle │
    │<─────────────────────────────│               │
    │                              │               │
    │  待機（ユーザー指定秒数）     │               │
    │  ...                         │               │
    │  （ページ数分繰り返し）       │               │
```

### macOS実装詳細

| 処理 | 使用ライブラリ/API |
|------|-------------------|
| ウィンドウ一覧取得 | `Quartz` (CGWindowListCopyWindowInfo) |
| コンテンツ領域計算 | ウィンドウ座標からタイトルバー高さ(28px)を除外 |
| スクリーンショット | `pyautogui.screenshot(region=...)` |
| キー送信 | `pyautogui.press('right')` / `press('left')` |
| アプリをフォアグラウンドに | `AppKit` (NSRunningApplication) |

## PDF生成

### 仕様

| 項目 | 仕様 |
|------|------|
| ライブラリ | `img2pdf`（画像品質を劣化させずPDF化） |
| 画像形式 | PNG（キャプチャ時）→ そのままPDFに埋め込み |
| ファイル名 | 全体: `output.pdf`、章別: `chapter_01_章名.pdf` |
| ページサイズ | 画像サイズに自動フィット |

### 章分割データ構造

```python
chapters = [
    {"name": "第1章 イントロダクション", "start": 0, "end": 5},
    {"name": "第2章 基本概念", "start": 6, "end": 20},
    {"name": "第3章 応用編", "start": 21, "end": 35},
]
```

### 出力フォルダ構成

```
~/Desktop/captures/2026-01-27_kindle_capture/
├── images/                    # 元画像（保存オプション有効時）
│   ├── page_001.png
│   ├── page_002.png
│   └── ...
├── output.pdf                 # 全体PDF
├── chapter_01_イントロダクション.pdf
├── chapter_02_基本概念.pdf
└── chapter_03_応用編.pdf
```

章を定義しなかった場合は全体PDFのみ出力。

## エラー処理

| 状況 | 対処 |
|------|------|
| 対象ウィンドウが閉じられた | キャプチャ停止、撮影済み分で章分割画面へ進むか確認 |
| ウィンドウが最小化された | 警告表示、ウィンドウを戻すよう促す |
| ディスク容量不足 | 事前に必要容量を概算表示（1ページ≒1-2MB × ページ数） |
| キャプチャ中に他アプリがフォーカス | キャプチャ前に毎回対象ウィンドウをフォアグラウンドに |

### キャプチャ中の注意表示

```
⚠️ キャプチャ中の注意:
• Kindleウィンドウを動かさないでください
• 他のウィンドウを前面に出さないでください
• キャプチャ完了まで操作をお待ちください
```

### キャンセル時の動作

- 確認ダイアログ:「キャプチャを中止しますか？撮影済みの画像は保持されます」
- 「はい」→ 章分割画面へ（途中までの画像でPDF作成可能）
- 「いいえ」→ キャプチャ継続
